# Build the docker image
# Push the docker image to docker hub
# SSH into our VM and start the new image

name : deploy to backend
on:
    push:
        branches: [ main ]
jobs:
    build:
        runs-on: ubuntu-latest
        steps:  
        - name: checkout
          uses: actions/checkout@v2
          with: 
            fetch-depth: 0  # Fetch all commits and branches (full history)

        - name: docker login
          uses: docker/login-action@v2
          with: 
                username: ${{ secrets.DOCKER_USERNAME }}
                password: ${{ secrets.DOCKER_PASSWORD }}
            
        - name: Build and push
          uses: docker/build-push-action@v4
          with:
            context: .
            file: ./docker/dockerfile.backend
            push: true
            tags: gaurav1149/todos-app-backend:${{ github.sha}}
        - run: |
            echo "${{ secrets.SSH_PRIVATE_KEY }}" &> ~/ssh_key
            chmod 700 /home/runner/ssh_key
            ssh -o StrictHostKeyChecking=no -i ssh_key root@43.204.214.105 -t sudo chmod 666 /var/run/docker.sock && docker stop todos_backend && docker run --name todos_backend -d -p 3001:3001 gaurav1149/todos-app-backend:${{ github.sha }}

